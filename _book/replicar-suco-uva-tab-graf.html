<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Cleuler Barbosa das Neves">
<title>8&nbsp; AED - suco uva - Tabelas e Gráficos – __Ciência de Dados e Estatística Aplicadas ao Direito e Políticas Públicas__</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 1em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cap16-moore-IC-o-basico.html" rel="next">
<link href="./cap6-moore-tab-dupla-entrada.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-70a47bd5681a7291082a5b9f83d58762.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./replicar-suco-uva-tab-graf.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">AED - suco uva - Tabelas e Gráficos</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><strong>Ciência de Dados e Estatística Aplicadas ao Direito e Políticas Públicas</strong></a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pretexto</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introdução</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./AEID-cap18-Reproduzivel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">AEID - Análise Exploratória e Inferencial de Dados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap3-DistNorm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">AED - cap 3 - As Distribuições Normais</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap5-pldr-modelos-dados.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">AED - cap 5 pldr - Ajustando Modelos aos Dados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap13-pldr-model-rel-contin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">AID - cap 13 - Modelagem de Relações Contínuas</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap16-pldr-EstMultiv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">AID - cap 16 - Estatística Multivariada</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap6-moore-tab-dupla-entrada.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">AED - cap 6 moore - Tabelas de Dupla Entrada</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./replicar-suco-uva-tab-graf.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">AED - suco uva - Tabelas e Gráficos</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap16-moore-IC-o-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">AEI - cap 16 moore - IC: o Básico</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap17-moore-TSHN-o-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">AEI - cap 17 moore - TSH0</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap17-LO-testes-significancia-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Testes de Significância: o Básico</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap17-TSHo-Oltramari.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Testes de Significância: Oltramari</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap18-LO-inferencia-na-pratica.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Inferência na Prática</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusao.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Conclusão</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apendiceA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Apêndice A - EMENTA</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apendiceB-quadroVar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Apêndice B - Quadro Var</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referências</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Sumário</h2>
   
  <ul>
<li><a href="#objetivos-da-aprendizagem" id="toc-objetivos-da-aprendizagem" class="nav-link active" data-scroll-target="#objetivos-da-aprendizagem"><span class="header-section-number">8.1</span> Objetivos da Aprendizagem</a></li>
  <li>
<a href="#suco-de-uva" id="toc-suco-de-uva" class="nav-link" data-scroll-target="#suco-de-uva"><span class="header-section-number">8.2</span> Suco de uva</a>
  <ul>
<li><a href="#replicar-tabela-m%C3%AAs-a-m%C3%AAs" id="toc-replicar-tabela-mês-a-mês" class="nav-link" data-scroll-target="#replicar-tabela-m%C3%AAs-a-m%C3%AAs"><span class="header-section-number">8.2.1</span> Replicar tabela mês a mês</a></li>
  <li><a href="#qui-quadrado-dados-agregados" id="toc-qui-quadrado-dados-agregados" class="nav-link" data-scroll-target="#qui-quadrado-dados-agregados"><span class="header-section-number">8.2.2</span> Qui-quadrado dados agregados</a></li>
  <li><a href="#gr%C3%A1fico-barras-agregado" id="toc-gráfico-barras-agregado" class="nav-link" data-scroll-target="#gr%C3%A1fico-barras-agregado"><span class="header-section-number">8.2.3</span> Gráfico barras agregado</a></li>
  <li><a href="#gr%C3%A1fico-barras-facetas" id="toc-gráfico-barras-facetas" class="nav-link" data-scroll-target="#gr%C3%A1fico-barras-facetas"><span class="header-section-number">8.2.4</span> Gráfico barras facetas</a></li>
  <li><a href="#gr%C3%A1fico-da-s%C3%A9rie-temporal" id="toc-gráfico-da-série-temporal" class="nav-link" data-scroll-target="#gr%C3%A1fico-da-s%C3%A9rie-temporal"><span class="header-section-number">8.2.5</span> Gráfico da Série temporal</a></li>
  <li><a href="#gr%C3%A1fico-da-ingest%C3%A3o-de-suco" id="toc-gráfico-da-ingestão-de-suco" class="nav-link" data-scroll-target="#gr%C3%A1fico-da-ingest%C3%A3o-de-suco"><span class="header-section-number">8.2.6</span> Gráfico da ingestão de suco</a></li>
  <li><a href="#gr%C3%A1fico-do-efeito-dos-conciliadores-no-gt" id="toc-gráfico-do-efeito-dos-conciliadores-no-gt" class="nav-link" data-scroll-target="#gr%C3%A1fico-do-efeito-dos-conciliadores-no-gt"><span class="header-section-number">8.2.7</span> Gráfico do efeito dos conciliadores no GT</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-suco-uva-tab-graf" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">AED - suco uva - Tabelas e Gráficos</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="objetivos-da-aprendizagem" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="objetivos-da-aprendizagem">
<span class="header-section-number">8.1</span> Objetivos da Aprendizagem</h2>
<blockquote class="blockquote">
<p>Após ler este relatório de pesquisa, você deve ser capaz de:</p>
<p>▶ 1 Calcular e interpretar <strong><em>distribuições marginais</em></strong> em tabelas de dupla entrada.</p>
<p>▶ 2 Calcular e interpretar <strong><em>distribuições condicionais</em></strong> em tabelas de dupla entrada.</p>
<p>▶ 3 Reconhecer e explicar o <strong><em>paradoxo de Simpson</em></strong>. <span class="citation" data-cites="Moore2023">(<a href="referencias.html#ref-Moore2023" role="doc-biblioref">MOORE; NOTZ; FLIGNER, 2023</a> , p.&nbsp;130)</span>.</p>
<p>▶ 4 Resumir dados em tabelas de dupla entrada e interpretá-las.</p>
<p>▶ 5 Visualizar gráficos adequados para esse tipo de dado e interpretá-los.</p>
<p>▶ 6 Capturar modelos adequados e interpretá-los.</p>
</blockquote>
<p>Os dados dessa pesquisa empírica em Direito e Políticas Públicas foram estraídos de <span class="citation" data-cites="Aline-2020-sucouva">(<a href="referencias.html#ref-Aline-2020-sucouva" role="doc-biblioref">TOMÁS, 2020</a>)</span>.</p>
</section><section id="suco-de-uva" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="suco-de-uva">
<span class="header-section-number">8.2</span> Suco de uva</h2>
<section id="replicar-tabela-mês-a-mês" class="level3" data-number="8.2.1"><h3 data-number="8.2.1" class="anchored" data-anchor-id="replicar-tabela-mês-a-mês">
<span class="header-section-number">8.2.1</span> Replicar tabela mês a mês</h3>
<p>Grupo de Controle (GC) -x- Grupo de Taratamento (GT)</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Gera tabela mensal com contagens por grupo (Controle/Experimental), calcula qui-quadrado 2x2 por mês</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># e acrescenta notação de significância.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Corrigido: evita avaliação lógica com vetor (&gt;1) usando inherits(..., "htest").</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pacotes (instala se necessário)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"knitr"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Dados (criados com data.frame base)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Mes =</span> <span class="fu">c</span>(<span class="st">"Abril"</span>,<span class="st">"Abril"</span>,<span class="st">"Maio"</span>,<span class="st">"Maio"</span>,<span class="st">"Junho"</span>,<span class="st">"Junho"</span>,<span class="st">"Julho"</span>,<span class="st">"Julho"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Agosto"</span>,<span class="st">"Agosto"</span>,<span class="st">"Setembro"</span>,<span class="st">"Setembro"</span>,<span class="st">"Outubro"</span>,<span class="st">"Outubro"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Novembro"</span>,<span class="st">"Novembro"</span>,<span class="st">"Dezembro"</span>,<span class="st">"Dezembro"</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">Grupo =</span> <span class="fu">c</span>(<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>,<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Nao =</span> <span class="fu">c</span>(<span class="dv">35</span>,<span class="dv">20</span>,<span class="dv">17</span>, <span class="dv">7</span>,<span class="dv">18</span>,<span class="dv">17</span>,<span class="dv">20</span>, <span class="dv">4</span>,<span class="dv">19</span>, <span class="dv">8</span>,<span class="dv">24</span>,<span class="dv">13</span>,<span class="dv">8</span>, <span class="dv">3</span>,<span class="dv">16</span>,<span class="dv">10</span>,<span class="dv">10</span>, <span class="dv">2</span>),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sim =</span> <span class="fu">c</span>(<span class="dv">31</span>,<span class="dv">54</span>,<span class="dv">16</span>,<span class="dv">38</span>,<span class="dv">13</span>,<span class="dv">19</span>,<span class="dv">14</span>,<span class="dv">33</span>,<span class="dv">20</span>,<span class="dv">24</span>,<span class="dv">26</span>,<span class="dv">30</span>,<span class="dv">6</span>,<span class="dv">11</span>, <span class="dv">8</span>,<span class="dv">49</span>, <span class="dv">4</span>,<span class="dv">12</span>), <span class="co"># 54 em vez 74</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>                                      <span class="co"># pois 54+20=74</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Função utilitária: formata qui-quadrado + estrelas de significância</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>stars_from_p <span class="ot">&lt;-</span> <span class="cf">function</span>(p) {</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p))  <span class="fu">return</span>(<span class="st">""</span>)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># caractere de ponto em posição elevada (dot above)</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  dot <span class="ot">&lt;-</span> <span class="st">"\u02D9"</span>  <span class="co"># '˙' (dot above) — aparece como pequeno ponto superiorizado</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="fu">return</span>(<span class="st">"**"</span>) <span class="co"># teste significativo a 99% de confiança</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="fu">return</span>(<span class="st">"*"</span>)  <span class="co"># teste significativo a 95% de confiança</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.10</span>) <span class="fu">return</span>(dot)   <span class="co"># teste significativo a 90% de confiança</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="st">""</span>) </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular qui-quadrado (Pearson) por mês</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>res_list <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Mes) <span class="sc">%&gt;%</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_nao =</span> Nao[Grupo <span class="sc">==</span> <span class="st">"Controle"</span>],</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_sim =</span> Sim[Grupo <span class="sc">==</span> <span class="st">"Controle"</span>],</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_nao =</span> Nao[Grupo <span class="sc">==</span> <span class="st">"Experimental"</span>],</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_sim =</span> Sim[Grupo <span class="sc">==</span> <span class="st">"Experimental"</span>],</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">chi =</span> {</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(c_nao, c_sim, e_nao, e_sim), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>      tst <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">chisq.test</span>(m, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(tst, <span class="st">"htest"</span>)) {</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>  <span class="co"># teste inválido ou erro -&gt; string vazia</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        stat <span class="ot">&lt;-</span> <span class="fu">unname</span>(tst<span class="sc">$</span>statistic)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        pval <span class="ot">&lt;-</span> tst<span class="sc">$</span>p.value</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        stat_rounded <span class="ot">&lt;-</span> <span class="fu">formatC</span>(stat, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">format =</span> <span class="st">"f"</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(stat_rounded, <span class="fu">stars_from_p</span>(pval))</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">pval =</span> {</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(c_nao, c_sim, e_nao, e_sim), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>      tst <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">chisq.test</span>(m, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(tst, <span class="st">"htest"</span>)) {</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>  <span class="co"># teste inválido ou erro -&gt; string vazia</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        pval <span class="ot">&lt;-</span> tst<span class="sc">$</span>p.value</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">formatC</span>(pval, <span class="at">digits =</span> <span class="dv">4</span>, <span class="at">format =</span> <span class="st">"f"</span>)</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Mes, chi, pval)</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Juntar resultado à tabela original (mostrar chi apenas na linha Controle)</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>tabela_final <span class="ot">&lt;-</span> dados <span class="sc">%&gt;%</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(res_list, <span class="at">by =</span> <span class="st">"Mes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Mes) <span class="sc">%&gt;%</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">Valor_do_qui_quadrado =</span> <span class="fu">ifelse</span>(Grupo <span class="sc">==</span> <span class="st">"Controle"</span>, chi, <span class="st">""</span>),</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">Valor_p =</span> <span class="fu">ifelse</span>(Grupo <span class="sc">==</span> <span class="st">"Controle"</span>, pval, <span class="st">""</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Mes, Grupo, Nao, Sim, Valor_do_qui_quadrado, Valor_p)</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Exibir tabela formatada</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tabela com qui-quadrado por mês (aparecendo na linha Controle):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">kable</span>(tabela_final, <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"c"</span>, <span class="st">"l"</span>)))</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="co"># (Opcional) salvar CSV:</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(tabela_final, "tabela_mensal_chisq.csv", row.names = FALSE)</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Tabela com qui-quadrado por mês (aparecendo na linha Controle):


|Mes      |Grupo        | Nao| Sim |Valor_do_qui_quadrado |Valor_p |
|:--------|:------------|---:|:---:|:---------------------|:-------|
|Abril    |Controle     |  35| 31  |9.89**                |0.0017  |
|Abril    |Experimental |  20| 54  |                      |        |
|Maio     |Controle     |  17| 16  |11.56**               |0.0007  |
|Maio     |Experimental |   7| 38  |                      |        |
|Junho    |Controle     |  18| 13  |0.78                  |0.3757  |
|Junho    |Experimental |  17| 19  |                      |        |
|Julho    |Controle     |  20| 14  |18.25**               |0.0000  |
|Julho    |Experimental |   4| 33  |                      |        |
|Agosto   |Controle     |  19| 20  |4.20*                 |0.0405  |
|Agosto   |Experimental |   8| 24  |                      |        |
|Setembro |Controle     |  24| 26  |3.05˙                 |0.0809  |
|Setembro |Experimental |  13| 30  |                      |        |
|Outubro  |Controle     |   8|  6  |3.74˙                 |0.0530  |
|Outubro  |Experimental |   3| 11  |                      |        |
|Novembro |Controle     |  16|  8  |19.60**               |0.0000  |
|Novembro |Experimental |  10| 49  |                      |        |
|Dezembro |Controle     |  10|  4  |9.33**                |0.0023  |
|Dezembro |Experimental |   2| 12  |                      |        |</code></pre>
</div>
</div>
</section><section id="qui-quadrado-dados-agregados" class="level3" data-number="8.2.2"><h3 data-number="8.2.2" class="anchored" data-anchor-id="qui-quadrado-dados-agregados">
<span class="header-section-number">8.2.2</span> Qui-quadrado dados agregados</h3>
<p>Teste qui-quadrado para todo o conjunto de dados não desagregado mês a mês.</p>
<p>Manter os meses em ordem cronológica.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Teste qui-quadrado agregando todos os meses em Controle vs Tratamento</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># e executando testes por mês com meses ordenados cronologicamente.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Entrada: objeto 'tabela_final' ou 'dados' no ambiente (colunas Mes, Grupo, Nao, Sim),</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ou arquivo "tabela_mensal_chisq.csv".</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Saídas: tabela agregada 2x2, resultado do chi-squared (ou Fisher), phi e resultados por mês</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># com meses exibidos na ordem: Abril, Maio, Junho, Julho, Agosto, Setembro, Outubro, Novembro, Dezembro.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"tidyr"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Obter data.frame (procura objetos no ambiente ou CSV) ---</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"tabela_final"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"tabela_final"</span>, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"dados"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"dados"</span>, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="st">"tabela_mensal_chisq.csv"</span>)) {</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"tabela_mensal_chisq.csv"</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>, <span class="at">fileEncoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Não encontrei 'tabela_final' nem 'dados' no ambiente, nem o ficheiro 'tabela_mensal_chisq.csv'."</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Normalizar nomes de colunas (minúsculas, sem caracteres especiais) ---</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(df))</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-z0-9_]"</span>, <span class="st">"_"</span>, <span class="fu">names</span>(df))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># identificar possíveis colunas</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>col_grupo <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(<span class="st">"grupo"</span>,<span class="st">"group"</span>,<span class="st">"tratamento"</span>,<span class="st">"treatment"</span>))</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>col_nao   <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"nao_"</span>,<span class="st">"n_nao"</span>,<span class="st">"n_nao"</span>,<span class="st">"no"</span>,<span class="st">"n"</span>))</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>col_sim   <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(<span class="st">"sim"</span>,<span class="st">"yes"</span>,<span class="st">"y"</span>,<span class="st">"s"</span>))</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co"># detectar coluna de mês por padrão buscando substrings</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>col_mes <span class="ot">&lt;-</span> <span class="fu">names</span>(df)[<span class="fu">grepl</span>(<span class="st">"mes|month|m_"</span>, <span class="fu">names</span>(df), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(col_grupo) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Coluna de grupo não encontrada (procure por 'Grupo'/'group')."</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(col_nao) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(col_sim) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Colunas de contagem 'Nao' e 'Sim' não foram encontradas."</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>col_grupo <span class="ot">&lt;-</span> col_grupo[<span class="dv">1</span>]</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>col_nao   <span class="ot">&lt;-</span> col_nao[<span class="dv">1</span>]</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>col_sim   <span class="ot">&lt;-</span> col_sim[<span class="dv">1</span>]</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>mes_col   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(col_mes) <span class="sc">&gt;=</span> <span class="dv">1</span>) col_mes[<span class="dv">1</span>] <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Padronizar rótulos de grupo: Controle / Tratamento ---</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">grupo_raw =</span> <span class="fu">as.character</span>(.data[[col_grupo]]),</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">grupo =</span> <span class="fu">ifelse</span>(<span class="fu">tolower</span>(<span class="fu">trimws</span>(grupo_raw)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"controle"</span>,<span class="st">"control"</span>), <span class="st">"Controle"</span>, <span class="st">"Tratamento"</span>),</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_nao =</span> <span class="fu">as.numeric</span>(.data[[col_nao]]),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_sim =</span> <span class="fu">as.numeric</span>(.data[[col_sim]])</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Ordenar meses (se coluna de mês existir) ---</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>month_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Abril"</span>,<span class="st">"Maio"</span>,<span class="st">"Junho"</span>,<span class="st">"Julho"</span>,<span class="st">"Agosto"</span>,<span class="st">"Setembro"</span>,<span class="st">"Outubro"</span>,<span class="st">"Novembro"</span>,<span class="st">"Dezembro"</span>)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mes_col)) {</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapear valores existentes para título padrão dos meses quando possível (ignora case)</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  map_month_value <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(v)) <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    v_trim <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(v))</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tentar correspondência direta ignorando case</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    match_idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(v_trim), <span class="fu">tolower</span>(month_levels))</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(match_idx)) <span class="fu">return</span>(month_levels[match_idx])</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tentar remover acentos e comparar (fallback)</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    v_clean <span class="ot">&lt;-</span> <span class="fu">iconv</span>(v_trim, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    match_idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(v_clean), <span class="fu">tolower</span>(<span class="fu">iconv</span>(month_levels, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)))</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(match_idx)) <span class="fu">return</span>(month_levels[match_idx])</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># se não reconhecer, retorna o valor original (será colocado após os níveis definidos)</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(v_trim)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>mes_mapped <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df[[mes_col]], map_month_value, <span class="fu">character</span>(<span class="dv">1</span>))</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># definir factor com níveis na ordem desejada; níveis extras (não reconhecidos) ficarão NA se não estiverem incluídos</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># incluir somente os meses presentes entre os month_levels para evitar NAs indesejadas</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  present_levels <span class="ot">&lt;-</span> <span class="fu">intersect</span>(month_levels, <span class="fu">unique</span>(df<span class="sc">$</span>mes_mapped))</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(present_levels) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># se nenhum mês reconhecido, criar factor com ordem alfabética dos valores existentes</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>mes_ord <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>mes_mapped, <span class="at">levels =</span> <span class="fu">unique</span>(df<span class="sc">$</span>mes_mapped))</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>mes_ord <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>mes_mapped, <span class="at">levels =</span> month_levels)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>mes_ord <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Agregar todos os meses por grupo (somar Nao/Sim) para teste agregado ---</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>agg <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grupo) <span class="sc">%&gt;%</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">nao =</span> <span class="fu">sum</span>(n_nao, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">sim =</span> <span class="fu">sum</span>(n_sim, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a><span class="co"># garantir linhas Controle/Tratamento</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>agg <span class="ot">&lt;-</span> agg <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grupo =</span> <span class="fu">ifelse</span>(grupo <span class="sc">==</span> <span class="st">"Controle"</span>, <span class="st">"Controle"</span>, <span class="st">"Tratamento"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grupo) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">nao =</span> <span class="fu">sum</span>(nao), <span class="at">sim =</span> <span class="fu">sum</span>(sim), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">match</span>(grupo, <span class="fu">c</span>(<span class="st">"Controle"</span>,<span class="st">"Tratamento"</span>)))</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="co"># construir tabela 2x2</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(agg<span class="sc">$</span>nao[agg<span class="sc">$</span>grupo<span class="sc">==</span><span class="st">"Controle"</span>], agg<span class="sc">$</span>sim[agg<span class="sc">$</span>grupo<span class="sc">==</span><span class="st">"Controle"</span>],</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>                agg<span class="sc">$</span>nao[agg<span class="sc">$</span>grupo<span class="sc">==</span><span class="st">"Tratamento"</span>], agg<span class="sc">$</span>sim[agg<span class="sc">$</span>grupo<span class="sc">==</span><span class="st">"Tratamento"</span>]),</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>              <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Controle"</span>,<span class="st">"Tratamento"</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Nao"</span>,<span class="st">"Sim"</span>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tabela agregada (linhas = Grupo; colunas = Nao/Sim):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabela de contingência (linhas = Grupo, colunas = acordo Nao/Sim)</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Adicionar totais marginais (linha e coluna)</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>tab_totais <span class="ot">&lt;-</span> <span class="fu">addmargins</span>(tab)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Substituir o rótulo padrão "Sum" por "Total" nas margens (mais legível em pt-BR)</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tab_totais)[<span class="fu">nrow</span>(tab_totais)] <span class="ot">&lt;-</span> <span class="st">"Total"</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tab_totais)[<span class="fu">ncol</span>(tab_totais)] <span class="ot">&lt;-</span> <span class="st">"Total"</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Exibir tabela com totais marginais</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tabela com totais marginais:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab_totais)</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Observar que o total de 659 observações confere</span><span class="sc">\n</span><span class="st">com o tamanho da amostra reportado: n = 659</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">O Grupo de Controle confere com o reportado (n_GC = 305 audiências).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">E o Grupo de Experimental confere c/o reportado (n_GT = 354 audiências).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Marginais em contagem ---</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Totais por linha (por grupo: controle x tratamento)</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>margem_linhas <span class="ot">&lt;-</span> <span class="fu">margin.table</span>(tab, <span class="dv">1</span>)</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Totais por coluna (por acordo: sim ou não)</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>margem_colunas <span class="ot">&lt;-</span> <span class="fu">margin.table</span>(tab, <span class="dv">2</span>)</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Marginal — por grupo: controle x tratamento (contagem):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(margem_linhas)</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Marginal — por acordo: sim ou não (contagem):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(margem_colunas)</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Marginais em proporção (relativas ao total geral) ---</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>prop_linhas  <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(margem_linhas)  <span class="co"># soma = 1</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>prop_colunas <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(margem_colunas) <span class="co"># soma = 1</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Marginal — por grupo: controle x tratamento (proporção % do total):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">round</span>(prop_linhas, <span class="dv">4</span>))</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Marginal — por acordo: sim ou não (proporção % do total):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">round</span>(prop_colunas, <span class="dv">4</span>))</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Teste qui-quadrado agregado (ou Fisher se necessário) ---</span></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>chisq_ok <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>tst_chisq <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">chisq.test</span>(tab, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) e)</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">inherits</span>(tst_chisq, <span class="st">"error"</span>)) {</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>  chisq_ok <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"chisq.test falhou: "</span>, tst_chisq<span class="sc">$</span>message)</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>  expc <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tst_chisq<span class="sc">$</span>expected)</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(expc <span class="sc">&lt;</span> <span class="dv">5</span>)) {</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    chisq_ok <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Algumas frequências esperadas &lt; 5; usaremos Fisher exact test em vez de qui-quadrado."</span>)</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (chisq_ok) {</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Resultado do chi-squared test (Pearson):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(tst_chisq)</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>  chi_stat <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tst_chisq<span class="sc">$</span>statistic)[<span class="dv">1</span>]</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tst_chisq<span class="sc">$</span>p.value)[<span class="dv">1</span>]</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>  fisher_res <span class="ot">&lt;-</span> <span class="fu">fisher.test</span>(tab)</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Resultado do Fisher exact test:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fisher_res)</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>  chi_stat <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(fisher_res<span class="sc">$</span>p.value)[<span class="dv">1</span>]</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Medida de efeito phi para 2x2 ---</span></span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> <span class="fu">sum</span>(tab)</span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(chi_stat)) {</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(chi_stat <span class="sc">/</span> n_total)</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Phi (efeito para 2x2) = %.4f</span><span class="sc">\n</span><span class="st">"</span>, phi))</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tentar calcular chi via chisq.test fallback</span></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>  chi_manual <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>    ch <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(tab, <span class="at">correct =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(ch<span class="sc">$</span>statistic)</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(chi_manual)) {</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(chi_manual <span class="sc">/</span> n_total)</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Phi (calculado por fallback) = %.4f</span><span class="sc">\n</span><span class="st">"</span>, phi))</span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Phi não disponível (teste Fisher usado e chi2 não calculável).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Testes por mês ordenados (se coluna de mês detectada) ---</span></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mes_col)) {</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Testes por mês (ordenados):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>  per_month <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(mes_ord, grupo) <span class="sc">%&gt;%</span></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">nao =</span> <span class="fu">sum</span>(n_nao, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">sim =</span> <span class="fu">sum</span>(n_sim, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># garantir que todos grupos apareçam para cada mês</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">complete</span>(mes_ord, grupo, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">nao =</span> <span class="dv">0</span>, <span class="at">sim =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(mes_ord, grupo)</span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iterar mantendo a ordem de mes_ord (fator)</span></span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>  months_to_iter <span class="ot">&lt;-</span> <span class="fu">unique</span>(per_month<span class="sc">$</span>mes_ord)</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (m <span class="cf">in</span> months_to_iter) {</span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> <span class="fu">filter</span>(per_month, mes_ord <span class="sc">==</span> m)</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># montar matriz 2x2 Controle vs Tratamento</span></span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>    row_ctrl <span class="ot">&lt;-</span> sub <span class="sc">%&gt;%</span> <span class="fu">filter</span>(grupo <span class="sc">==</span> <span class="st">"Controle"</span>)</span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>    row_trt  <span class="ot">&lt;-</span> sub <span class="sc">%&gt;%</span> <span class="fu">filter</span>(grupo <span class="sc">==</span> <span class="st">"Tratamento"</span>)</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>    mtx <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(row_ctrl<span class="sc">$</span>nao, row_ctrl<span class="sc">$</span>sim, row_trt<span class="sc">$</span>nao, row_trt<span class="sc">$</span>sim), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># escolher teste apropriado</span></span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>    tst <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">chisq.test</span>(mtx, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(tst) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">suppressWarnings</span>(tst<span class="sc">$</span>expected) <span class="sc">&lt;</span> <span class="dv">5</span>)) {</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>      tstf <span class="ot">&lt;-</span> <span class="fu">fisher.test</span>(mtx)</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%-10s: Fisher p = %.4g (Controle: %d/%d, Tratamento: %d/%d)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">as.character</span>(m), tstf<span class="sc">$</span>p.value,</span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>                  row_ctrl<span class="sc">$</span>nao, row_ctrl<span class="sc">$</span>nao <span class="sc">+</span> row_ctrl<span class="sc">$</span>sim,</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>                  row_trt<span class="sc">$</span>nao, row_trt<span class="sc">$</span>nao <span class="sc">+</span> row_trt<span class="sc">$</span>sim))</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%-10s: chi2 = %.2f, p = %.4g (Controle: %d/%d, Tratamento: %d/%d)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">as.character</span>(m), <span class="fu">as.numeric</span>(tst<span class="sc">$</span>statistic), <span class="fu">as.numeric</span>(tst<span class="sc">$</span>p.value),</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>                  row_ctrl<span class="sc">$</span>nao, row_ctrl<span class="sc">$</span>nao <span class="sc">+</span> row_ctrl<span class="sc">$</span>sim,</span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>                  row_trt<span class="sc">$</span>nao, row_trt<span class="sc">$</span>nao <span class="sc">+</span> row_trt<span class="sc">$</span>sim))</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Análise concluída.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Tabela agregada (linhas = Grupo; colunas = Nao/Sim):
           Nao Sim
Controle   167 138
Tratamento  84 270

Tabela com totais marginais:
           Nao Sim Total
Controle   167 138   305
Tratamento  84 270   354
Total      251 408   659

Observar que o total de 659 observações confere
com o tamanho da amostra reportado: n = 659


O Grupo de Controle confere com o reportado (n_GC = 305 audiências).


E o Grupo de Experimental confere c/o reportado (n_GT = 354 audiências).

Marginal — por grupo: controle x tratamento (contagem):
  Controle Tratamento 
       305        354 

Marginal — por acordo: sim ou não (contagem):
Nao Sim 
251 408 

Marginal — por grupo: controle x tratamento (proporção % do total):
  Controle Tratamento 
     46.28      53.72 

Marginal — por acordo: sim ou não (proporção % do total):
  Nao   Sim 
38.09 61.91 

Resultado do chi-squared test (Pearson):

    Pearson's Chi-squared test

data:  tab
X-squared = 66.878, df = 1, p-value = 2.888e-16


Phi (efeito para 2x2) = 0.3186

Testes por mês (ordenados):
Abril     : chi2 = 9.89, p = 0.001662 (Controle: 35/66, Tratamento: 20/74)
Maio      : chi2 = 11.56, p = 0.0006749 (Controle: 17/33, Tratamento: 7/45)
Junho     : chi2 = 0.78, p = 0.3757 (Controle: 18/31, Tratamento: 17/36)
Julho     : chi2 = 18.25, p = 1.934e-05 (Controle: 20/34, Tratamento: 4/37)
Agosto    : chi2 = 4.20, p = 0.04053 (Controle: 19/39, Tratamento: 8/32)
Setembro  : chi2 = 3.05, p = 0.08092 (Controle: 24/50, Tratamento: 13/43)
Outubro   : chi2 = 3.74, p = 0.05302 (Controle: 8/14, Tratamento: 3/14)
Novembro  : chi2 = 19.60, p = 9.534e-06 (Controle: 16/24, Tratamento: 10/59)
Dezembro  : chi2 = 9.33, p = 0.00225 (Controle: 10/14, Tratamento: 2/14)

Análise concluída.</code></pre>
</div>
</div>
</section><section id="gráfico-barras-agregado" class="level3" data-number="8.2.3"><h3 data-number="8.2.3" class="anchored" data-anchor-id="gráfico-barras-agregado">
<span class="header-section-number">8.2.3</span> Gráfico barras agregado</h3>
<p>Gráfico de barras empilhadas dos dados agregados com as proporções indicadas e o valor-p também.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico de barras empilhadas com proporções e valor-p agregado</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - Detecta/analisa dados agregados no ambiente ou arquivo "tabela_mensal_chisq.csv"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - Calcula chi-squared (ou Fisher se necessário) e anota p-valor no gráfico</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - Rótulos percentuais dentro dos segmentos (omitidos se muito pequenos)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pacotes necessários</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"scales"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"scales"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># montar tabela 2x2 (linhas = grupo; colunas = nao/sim)</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>tab_mat <span class="ot">&lt;-</span> tab</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>agg_df  <span class="ot">&lt;-</span> <span class="fu">as.data.frame.matrix</span>(tab)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>agg_df<span class="sc">$</span>grupo <span class="ot">&lt;-</span> <span class="fu">rownames</span>(agg_df)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(agg_df) <span class="ot">&lt;-</span> <span class="fu">tolower</span>( <span class="fu">names</span>(agg_df) )</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>agg_df <span class="ot">&lt;-</span> agg_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(grupo, <span class="fu">everything</span>())</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Teste estatístico (chi-square ou Fisher se necessário) ---</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>use_fisher <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>test_res <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">chisq.test</span>(tab_mat, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) e)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">inherits</span>(test_res, <span class="st">"error"</span>)) {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  use_fisher <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  expc <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(test_res<span class="sc">$</span>expected)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(expc <span class="sc">&lt;</span> <span class="dv">5</span>)) use_fisher <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_fisher) {</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  test_f <span class="ot">&lt;-</span> <span class="fu">fisher.test</span>(tab_mat)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  pval   <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(test_f<span class="sc">$</span>p.value)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  test_label <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"Fisher exact (p = %s)"</span>, <span class="fu">ifelse</span>(pval <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"&lt;0.001"</span>, <span class="fu">format.pval</span>(pval, <span class="at">digits =</span> <span class="dv">3</span>)))</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  test_chi <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(tab_mat, <span class="at">correct =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  pval     <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(test_chi<span class="sc">$</span>p.value)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  test_label <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"Chi-square (p = %s, X² = %.2f)"</span>, <span class="fu">ifelse</span>(pval <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"&lt;0.001"</span>, <span class="fu">format.pval</span>(pval, <span class="at">digits =</span> <span class="dv">3</span>)), <span class="fu">as.numeric</span>(test_chi<span class="sc">$</span>statistic))</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Preparar dados para plotagem (formato long) ---</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> agg_df <span class="sc">%&gt;%</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"sim"</span>),</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"resposta"</span>,</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"contagem"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grupo) <span class="sc">%&gt;%</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">sum</span>(contagem),</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">prop =</span> contagem <span class="sc">/</span> total,</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_label =</span> <span class="fu">ifelse</span>(prop <span class="sc">&gt;=</span> <span class="fl">0.03</span>, <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>prop,<span class="dv">1</span>), <span class="st">"%"</span>), <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="co"># ordem das categorias na pilha (opcional: sim sobre nao)</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>plot_df<span class="sc">$</span>resposta <span class="ot">&lt;-</span> <span class="fu">factor</span>(plot_df<span class="sc">$</span>resposta, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"sim"</span>))</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Gráfico com título da legenda "Acordo" ---</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> grupo, <span class="at">y =</span> prop, <span class="at">fill =</span> resposta)) <span class="sc">+</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">colour =</span> <span class="st">"grey30"</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> pct_label),</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># definir quebras do eixo y de 0 a 1 (0% a 100%)</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># de 0.1 em 0.1 =&gt; mostra 0%,10%,...,100%</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">"Acordo"</span>, <span class="co"># &lt;-- título da legenda definido aqui</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                  <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"nao"</span> <span class="ot">=</span> <span class="st">"#bdbdbd"</span>, <span class="st">"sim"</span> <span class="ot">=</span> <span class="st">"#4E79A7"</span>),</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Não"</span>,<span class="st">"Sim"</span>)) <span class="sc">+</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Composição por resposta ao acordo (agregado)"</span>,</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> test_label,</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Grupo"</span>,</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Proporção dentro do grupo"</span>,</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"italic"</span>))</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a><span class="co"># expandir espaço superior para anotar p-valor num lugar destacado</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.09</span>))</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="co"># adicionar texto com p-valor acima das barras (centro)</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">annotate</span>(<span class="st">"text"</span>,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> <span class="fu">mean</span>(<span class="fu">seq_along</span>(<span class="fu">unique</span>(plot_df<span class="sc">$</span>grupo))),</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> <span class="fl">1.05</span>,</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>                  <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Teste: "</span>, test_label),</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">3.2</span>)</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a><span class="co"># exibir</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a><span class="co"># (Opcional) salvar figura</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("stacked_bar_aggregated_pvalue.png", p, width = 7, height = 5, dpi = 300)</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="replicar-suco-uva-tab-graf_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="gráfico-barras-facetas" class="level3" data-number="8.2.4"><h3 data-number="8.2.4" class="anchored" data-anchor-id="gráfico-barras-facetas">
<span class="header-section-number">8.2.4</span> Gráfico barras facetas</h3>
<p>O mesmo gráfico acima, um para cada mês, em facetas na ordem cronológica dos mêses.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Faceted stacked bars por mês com p-valor correto por faceta</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - calcula p-valor mês a mês (chi2 ou Fisher quando apropriado)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - anota cada faceta com o p-valor correspondente</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - reduz tamanho dos valores do eixo y</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Requisitos: ggplot2, dplyr, tidyr, scales</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"tidyr"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"scales"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"scales"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2); <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(scales)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- localizar/ler dados ---</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> tabela_final</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># --- normalizar nomes de colunas ---</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_raw) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(df_raw))</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_raw) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-z0-9_]"</span>, <span class="st">"_"</span>, <span class="fu">names</span>(df_raw))</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># identificar colunas</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>col_mes  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"mes"</span>,<span class="st">"month"</span>,<span class="st">"mês"</span>,<span class="st">"m"</span>))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>col_grp  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"grupo"</span>,<span class="st">"group"</span>,<span class="st">"tratamento"</span>,<span class="st">"treatment"</span>))</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>col_nao  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"no"</span>,<span class="st">"n_nao"</span>,<span class="st">"n_nao"</span>))</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>col_sim  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"sim"</span>,<span class="st">"yes"</span>,<span class="st">"y"</span>))</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(col_mes)<span class="sc">==</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Coluna de mês não encontrada (procure por 'Mes'/'month')."</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(col_grp)<span class="sc">==</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Coluna de grupo não encontrada (procure por 'Grupo')."</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(col_nao)<span class="sc">==</span><span class="dv">0</span> <span class="sc">||</span> <span class="fu">length</span>(col_sim)<span class="sc">==</span><span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Colunas de contagem 'Nao' e 'Sim' não encontradas."</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>mes_col <span class="ot">&lt;-</span> col_mes[<span class="dv">1</span>]; grp_col <span class="ot">&lt;-</span> col_grp[<span class="dv">1</span>]; nao_col <span class="ot">&lt;-</span> col_nao[<span class="dv">1</span>]; sim_col <span class="ot">&lt;-</span> col_sim[<span class="dv">1</span>]</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co"># --- padronizar meses e grupos ---</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>month_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Abril"</span>,<span class="st">"Maio"</span>,<span class="st">"Junho"</span>,<span class="st">"Julho"</span>,<span class="st">"Agosto"</span>,<span class="st">"Setembro"</span>,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Outubro"</span>,<span class="st">"Novembro"</span>,<span class="st">"Dezembro"</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>map_month <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  x0 <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(x0), <span class="fu">tolower</span>(month_levels))</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(idx)) <span class="fu">return</span>(month_levels[idx])</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  x_clean <span class="ot">&lt;-</span> <span class="fu">iconv</span>(x0, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  idx2 <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(x_clean), <span class="fu">tolower</span>(<span class="fu">iconv</span>(month_levels, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)))</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(idx2)) <span class="fu">return</span>(month_levels[idx2])</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x0)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">mes_raw =</span> .data[[mes_col]],</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">mes_mapped =</span> <span class="fu">vapply</span>(mes_raw, map_month, <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">mes_ord =</span> <span class="fu">factor</span>(mes_mapped, <span class="at">levels =</span> month_levels),</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">grupo_raw =</span> <span class="fu">as.character</span>(.data[[grp_col]]),</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">grupo =</span> <span class="fu">ifelse</span>(<span class="fu">tolower</span>(<span class="fu">trimws</span>(grupo_raw)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"controle"</span>,<span class="st">"control"</span>), <span class="st">"Controle"</span>, <span class="st">"Tratamento"</span>),</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">nao =</span> <span class="fu">as.numeric</span>(.data[[nao_col]]),</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">sim =</span> <span class="fu">as.numeric</span>(.data[[sim_col]])</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="co"># --- agregar por mês e grupo e garantir presença de ambos os grupos ---</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>per_month <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mes_ord, grupo) <span class="sc">%&gt;%</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">nao =</span> <span class="fu">sum</span>(nao, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">sim =</span> <span class="fu">sum</span>(sim, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mes_ord)) <span class="sc">%&gt;%</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="co"># garantir linhas para ambos grupos em cada mês (preencher com zeros)</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>per_month <span class="ot">&lt;-</span> per_month <span class="sc">%&gt;%</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(mes_ord, <span class="at">grupo =</span> <span class="fu">c</span>(<span class="st">"Controle"</span>, <span class="st">"Tratamento"</span>),</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">nao =</span> <span class="dv">0</span>, <span class="at">sim =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mes_ord, grupo)</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a><span class="co"># --- calcular p-valor corretamente para cada mês ---</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">unique</span>(per_month<span class="sc">$</span>mes_ord)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>p_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(months, <span class="cf">function</span>(m) {</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  sub <span class="ot">&lt;-</span> <span class="fu">filter</span>(per_month, mes_ord <span class="sc">==</span> m) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">match</span>(grupo, <span class="fu">c</span>(<span class="st">"Controle"</span>,<span class="st">"Tratamento"</span>)))</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># montar matriz 2x2</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  mtx <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(sub<span class="sc">$</span>nao[<span class="dv">1</span>], sub<span class="sc">$</span>sim[<span class="dv">1</span>], sub<span class="sc">$</span>nao[<span class="dv">2</span>], sub<span class="sc">$</span>sim[<span class="dv">2</span>]), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tentar chi2; se erro ou expected &lt; 5 usar Fisher</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>  tst <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">chisq.test</span>(mtx, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  test_type <span class="ot">&lt;-</span> <span class="cn">NA_character_</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(tst)) {</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> <span class="fu">fisher.test</span>(mtx)</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    pval <span class="ot">&lt;-</span> f<span class="sc">$</span>p.value; test_type <span class="ot">&lt;-</span> <span class="st">"Fisher"</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>    expc <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(tst<span class="sc">$</span>expected)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(expc <span class="sc">&lt;</span> <span class="dv">5</span>)) {</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>      f <span class="ot">&lt;-</span> <span class="fu">fisher.test</span>(mtx)</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>      pval <span class="ot">&lt;-</span> f<span class="sc">$</span>p.value; test_type <span class="ot">&lt;-</span> <span class="st">"Fisher"</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>      pval <span class="ot">&lt;-</span> tst<span class="sc">$</span>p.value; test_type <span class="ot">&lt;-</span> <span class="st">"Chi-square"</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">mes_ord =</span> m, <span class="at">p_value =</span> pval, <span class="at">test =</span> test_type)</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>p_by_month <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(p_list)</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Função utilitária: formata qui-quadrado + estrelas de significância</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>stars_from_p <span class="ot">&lt;-</span> <span class="cf">function</span>(p) {</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ( <span class="fu">is.na</span>(p) )  <span class="fu">return</span>(<span class="st">""</span>)</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># caractere de ponto em posição elevada (dot above)</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>  dot <span class="ot">&lt;-</span> <span class="st">"\u02D9"</span>  <span class="co"># '˙' (dot above) — aparece como pequeno ponto superiorizado</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.001</span>) <span class="fu">return</span>(<span class="st">"&lt;0.001"</span>) <span class="co"># teste significativo a 99.9% de confiança</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="fu">return</span>(<span class="st">"**"</span>)      <span class="co"># teste significativo a 99% de confiança</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="fu">return</span>(<span class="st">"*"</span>)       <span class="co"># teste significativo a 95% de confiança</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.10</span>) <span class="fu">return</span>(dot)       <span class="co"># teste significativo a 90% de confiança</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="st">""</span>) </span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a><span class="co"># label formatado</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a><span class="co"># sapply(p_by_month$p_value, FUN = stars_from_p)</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>p_by_month <span class="ot">&lt;-</span> p_by_month <span class="sc">%&gt;%</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_label =</span> <span class="fu">format.pval</span>(p_value, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>         <span class="at">label =</span> <span class="fu">paste0</span>(test, <span class="st">": p = "</span>, p_label,</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sapply</span>(p_by_month<span class="sc">$</span>p_value, <span class="at">FUN =</span> stars_from_p)))</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a><span class="co"># --- preparar dados para plotagem ---</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> per_month <span class="sc">%&gt;%</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"sim"</span>),</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to  =</span> <span class="st">"resposta"</span>,</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"contagem"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mes_ord, grupo) <span class="sc">%&gt;%</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">sum</span>(contagem), <span class="at">prop =</span> <span class="fu">ifelse</span>(total<span class="sc">&gt;</span><span class="dv">0</span>, contagem <span class="sc">/</span> total, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>plot_df<span class="sc">$</span>resposta <span class="ot">&lt;-</span> <span class="fu">factor</span>(plot_df<span class="sc">$</span>resposta, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"sim"</span>))</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a><span class="co"># annotation_df contém mes_ord para cada faceta</span></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>annotation_df <span class="ot">&lt;-</span> p_by_month <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fl">1.5</span>, <span class="at">y =</span> <span class="fl">1.08</span>)</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a><span class="co"># --- plot final ---</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> grupo, <span class="at">y =</span> prop, <span class="at">fill =</span> resposta)) <span class="sc">+</span></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">colour =</span> <span class="st">"grey30"</span>, <span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(prop <span class="sc">&gt;=</span> <span class="fl">0.03</span>, <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>prop,<span class="dv">1</span>), <span class="st">"%"</span>), <span class="st">""</span>)),</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>), <span class="at">colour =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> mes_ord, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.12</span>),</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>                     <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">"Acordo"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"nao"</span> <span class="ot">=</span> <span class="st">"#bdbdbd"</span>, <span class="st">"sim"</span> <span class="ot">=</span> <span class="st">"#4E79A7"</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Não"</span>,<span class="st">"Sim"</span>)) <span class="sc">+</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Composição por resposta ao acordo — por mês/2018 (n = 648)"</span>,</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Grupo"</span>,</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Proporção dentro grupos: Controle x Tratamento"</span>) <span class="sc">+</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>) <span class="co"># reduzir tamanho dos valores no eixo y</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> annotation_df,</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="fl">1.07</span>, <span class="at">label =</span> label),</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>            <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">2</span>)</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="replicar-suco-uva-tab-graf_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Mês de <strong>junho</strong> é explicado pela mudança no nudge para um simples “SIRVA-SE” colocado sobre a mesa em frente às partes (autor e réu).</p>
<p>Mês seguinte <strong>julho</strong> retornou-se para uma pessoa que entrava em cada audiência, servia o suco de uva para partes e seus advogados, depois dizia: “Podem se servir do suco pois é uma cortesia do Forum”. Assim como ocorrera nos meses anteriores de <strong>abril e maio</strong>. E assim permaneceu <strong>até o mês de dezembro</strong>.</p>
<p>Esse <em>nudge</em> mostrou-se muito mais persuasivo.</p>
<p>Todavia registrou-se <u><strong>falta de significância</strong></u>, no nivel de confiança adotado de 95% (erro tipo I = 5%), para os meses de <u><strong>setembro</strong></u> e <u><strong>outubro</strong></u><strong>/2018.</strong></p>
</section><section id="gráfico-da-série-temporal" class="level3" data-number="8.2.5"><h3 data-number="8.2.5" class="anchored" data-anchor-id="gráfico-da-série-temporal">
<span class="header-section-number">8.2.5</span> Gráfico da Série temporal</h3>
<p>Gráfico da Série temporal da proporção de Acordos de Conciliação (Grupos Experimental e de Controle).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Série temporal da proporção de Acordos de Conciliação (Controle vs Tratamento)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Saída: gráfico com proporções por mês, IC95% e eixo y em percentuais (0%..100%, passo 10%)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Requisitos: ggplot2, dplyr, tidyr, scales</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"tidyr"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"scales"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"scales"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2); <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(scales)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --- localizar data.frame mensal ---</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> tabela_final</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Normalizar nomes de colunas e identificar colunas relevantes ---</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_raw) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(df_raw))</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_raw) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-z0-9_]"</span>, <span class="st">"_"</span>, <span class="fu">names</span>(df_raw))</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>col_mes  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"mes"</span>,<span class="st">"month"</span>,<span class="st">"mês"</span>,<span class="st">"m"</span>))[<span class="dv">1</span>]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>col_grp  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"grupo"</span>,<span class="st">"group"</span>,<span class="st">"tratamento"</span>,<span class="st">"treatment"</span>))[<span class="dv">1</span>]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>col_nao  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"nao"</span>,<span class="st">"no"</span>,<span class="st">"n_nao"</span>,<span class="st">"n_nao"</span>))[<span class="dv">1</span>]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>col_sim  <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(df_raw), <span class="fu">c</span>(<span class="st">"sim"</span>,<span class="st">"yes"</span>,<span class="st">"y"</span>))[<span class="dv">1</span>]</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(<span class="fu">c</span>(col_mes, col_grp, col_nao, col_sim)))) <span class="fu">stop</span>(<span class="st">"Colunas esperadas (mes, grupo, nao, sim) não foram encontradas."</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Padronizar mês e grupo ---</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>month_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Abril"</span>,<span class="st">"Maio"</span>,<span class="st">"Junho"</span>,<span class="st">"Julho"</span>,<span class="st">"Agosto"</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Setembro"</span>,<span class="st">"Outubro"</span>,<span class="st">"Novembro"</span>,<span class="st">"Dezembro"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>map_month <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  x0 <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(x0), <span class="fu">tolower</span>(month_levels))</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(idx)) <span class="fu">return</span>(month_levels[idx])</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  x_clean <span class="ot">&lt;-</span> <span class="fu">iconv</span>(x0, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  idx2 <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(x_clean), <span class="fu">tolower</span>(<span class="fu">iconv</span>(month_levels, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)))</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(idx2)) <span class="fu">return</span>(month_levels[idx2])</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x0)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">mes_raw =</span> .data[[col_mes]],</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">mes =</span> <span class="fu">vapply</span>(mes_raw, map_month, <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">mes =</span> <span class="fu">factor</span>(mes, <span class="at">levels =</span> month_levels),</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">grupo_raw =</span> <span class="fu">as.character</span>(.data[[col_grp]]),</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">grupo =</span> <span class="fu">ifelse</span>(<span class="fu">tolower</span>(<span class="fu">trimws</span>(grupo_raw)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"controle"</span>,<span class="st">"control"</span>), <span class="st">"Controle"</span>, <span class="st">"Tratamento"</span>),</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">nao =</span> <span class="fu">as.numeric</span>(.data[[col_nao]]),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">sim =</span> <span class="fu">as.numeric</span>(.data[[col_sim]])</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mes))</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Agregar por mês e grupo (caso haja múltiplas linhas por combinação) ---</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>per_month <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mes, grupo) <span class="sc">%&gt;%</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">nao =</span> <span class="fu">sum</span>(nao, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">sim =</span> <span class="fu">sum</span>(sim, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(mes, <span class="at">grupo =</span> <span class="fu">c</span>(<span class="st">"Controle"</span>, <span class="st">"Tratamento"</span>), <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">nao =</span> <span class="dv">0</span>, <span class="at">sim =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mes, grupo)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Calcular proporção e IC95% (prop.test) para cada (mes, grupo) ---</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>stats <span class="ot">&lt;-</span> per_month <span class="sc">%&gt;%</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> <span class="fu">as.integer</span>(nao <span class="sc">+</span> sim),</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">successes =</span> <span class="fu">as.integer</span>(sim),</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop =</span> <span class="cf">if</span> (total <span class="sc">&gt;</span> <span class="dv">0</span>) successes <span class="sc">/</span> total <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci =</span> <span class="fu">list</span>(</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (total <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># prop.test devolve intervalo; tryCatch protege contra erros</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">prop.test</span>(successes, total, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.null</span>(res)) <span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>) <span class="cf">else</span> <span class="fu">as.numeric</span>(res<span class="sc">$</span>conf.int)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_low =</span> ci[[<span class="dv">1</span>]],</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_up  =</span> ci[[<span class="dv">2</span>]]</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mes, grupo, total, successes, prop, ci_low, ci_up)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Preparar para plotagem (long format se necessário) ---</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> stats <span class="sc">%&gt;%</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> <span class="fu">as.numeric</span>(prop), <span class="at">ci_low =</span> <span class="fu">as.numeric</span>(ci_low), <span class="at">ci_up =</span> <span class="fu">as.numeric</span>(ci_up))</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a><span class="co"># INVERSÃO DA ORDEM: definir factor com níveis invertidos (Tratamento primeiro, depois Controle)</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>plot_df<span class="sc">$</span>grupo <span class="ot">&lt;-</span> <span class="fu">factor</span>(plot_df<span class="sc">$</span>grupo, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Tratamento"</span>, <span class="st">"Controle"</span>))</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plot: linhas por grupo com pontos e barras de erro; eixo y 0%..100% ---</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x =</span> mes, <span class="at">y =</span> prop, <span class="at">group =</span> grupo, <span class="at">color =</span> grupo)) <span class="sc">+</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">2.4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_up), <span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># definir cores e BREAKS na ordem desejada para garantir legenda nessa ordem</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"Tratamento"</span>, <span class="st">"Controle"</span>),</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Controle"</span> <span class="ot">=</span> <span class="st">"#1F78B4"</span>, <span class="st">"Tratamento"</span> <span class="ot">=</span> <span class="st">"#E31A1C"</span>)) <span class="sc">+</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Série temporal: proporção de Acordos de Conciliação"</span>,</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparação entre Grupo Controle e Tratamento por mês/2018 (n=659)"</span>,</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mês"</span>, <span class="at">y =</span> <span class="st">"Proporção de Acordos (IC95%)"</span>,</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Grupo"</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Opcional: salvar figura</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("ts_prop_acordos_by_month_inverted_groups.png", p, width = 10, height = 5)</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Fim do script</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="replicar-suco-uva-tab-graf_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A observação de que “2 - Apenas 28 audiências de conciliação aconteceram no mês de <u><strong><em>outubro</em></strong></u>. Motivo: férias da magistrada.” <span class="citation" data-cites="Aline-2020-sucouva">(<a href="referencias.html#ref-Aline-2020-sucouva" role="doc-biblioref">TOMÁS, 2020</a> , p.&nbsp;221)</span>. Não serve de justificativa para a variação observada nesse mês. Uma vez que todas as condições do teste foram mantidas e <strong><em>não era a magistrada</em></strong> que conduzia as ausiências de conciliação juunto ao CEJUSC.</p>
<p>Outras observações registradas foram:</p>
<blockquote class="blockquote">
<p>“3 A <strong>Semana Nacional de Conciliação</strong> ocorreu entre os dias 5 e 9 de <u><em>novembro</em></u> de 2018.</p>
<p>4 Apenas 28 audiências de conciliação aconteceram no mês de <u><em>dezembro</em></u>. Motivo: <strong>Recesso forense</strong> a partir de 20 de dezembro. Fonte: Dados da pesquisa.” <span class="citation" data-cites="Aline-2020-sucouva">(<a href="referencias.html#ref-Aline-2020-sucouva" role="doc-biblioref">TOMÁS, 2020</a> , p.&nbsp;221)</span></p>
</blockquote>
<p>O que também não justifica a variação observada, nos meses de <u><strong>setembro</strong></u> e <u><strong>outubro</strong></u><strong>/2018</strong>, na replicação mensal deste <em>quase experimento</em>.</p>
<p>Como o experimento foi replicado por <strong><em>nove meses</em></strong>, o fato de em dois deles (2 / 9 = 22,2%) <strong><em>não resultar estatisticamente significativo</em></strong> é uma evidência no sentido que ele precisa ser novamente replicado, por período igual ou superior; pois há a possibilidade de que o acaso poderia ser uma explicação concorrente para a variabilidade desse subconjunto de insucessos.</p>
<p>E é preciso que suas <u><strong>circunstâncias</strong></u> sejam <u><strong>mais detidamente controladas</strong></u>, tais como:</p>
<ol type="1">
<li>aumentar o período de aplicação para 12 meses;</li>
<li>manter um único <em>nudge</em> do começo ao fim: pessoa que entra, serve o suco ou a água fresca e sempre repete os mesmos dizeres;</li>
<li>essa pessoa que serve não poderá dizer a ninguem o que foi servido em cada audiência;</li>
<li>
<strong><em>aleatorizar</em></strong> a ordem de chegada dos casos entre os doi grupos: de controle e tratamento;</li>
<li>utilizar <em>uma mesma sala</em> de conciliação para os dois grupos, desde que atenda à todas as recomendações da Resolução do CNJ;</li>
<li>
<strong><em>aleatorizar</em></strong> qual dos 4 conciliadores (2 homens e 2 mulheres) irá presidir cada audiência de conciliação. Valer-se de pelo menos dois conciliadores treinados e com experiência de pelo menos 3 anos (1 homem e 1 mulher), a serem aleatorizados para acada audiência.</li>
<li>
<strong><em>aleatorizar</em></strong> qual técnica de conciliação, entre seis encontradas na revisão da literatura, irá ser aplicada a cada audiência de conciliação;</li>
<li>
<strong><em>organizar as pautas</em></strong> das audiências de conciliação de modo a respeitar os itens 4, 5, 6 e 7;</li>
<li>para buscar atender um pouco mais ao “<em>duplo cego</em>”, servir tanto o suco de uva (Grupo de Tratamento) como o placebo água fresca (Grupo de Controle) em <em>copos de papel descartáveis não transparentes</em> e <em>grandes o suficiente</em>, de modo a evitar que o conciliador possa ver qual tipo de bebida (suco ou água) as partes e seus advogados estão ingerindo;</li>
<li>refletir se vale a pena servir água fresca apenas com corante para deixar ela com a mesma cor do suco de uva, mas sem adição de qualquer glicose e dizer: que se trata de um “<em>suco de uva diet</em>” servido como cortesia na sala do Grupo de Controle;</li>
<li>cuidar para que o Grupo de Controle mantenha seu <em>nível base de acordos observado no início do experimento</em> (abril a setembro de 2018, cf.&nbsp;<em>gráfico da série temporal</em> acima), <em>evitando-se</em> assim a <em>tendência de queda</em> observada nos meses de setembro a dezembro de 2018;</li>
<li>
<strong>Evitar</strong> que <strong><em>amostras pequenas</em></strong>, menores que trinta (n &lt; 30), ocorram em qualquer um dos dois Grupos: Controle e Tratamento. Por exemplo agrupando no mesmo CEJUSC, processos oriundos de mais de uam vara nos meses de outubro e dezembro/2018 (n = 14; cf.&nbsp;abaixo gráfico da série temporal da ingestão de suco &lt;sim/não&gt; apenas no Grupo de Tratamento).</li>
</ol></section><section id="gráfico-da-ingestão-de-suco" class="level3" data-number="8.2.6"><h3 data-number="8.2.6" class="anchored" data-anchor-id="gráfico-da-ingestão-de-suco">
<span class="header-section-number">8.2.6</span> Gráfico da ingestão de suco</h3>
<p>Gerar dados sobre ingestão ou não de suci de uvo apenas no Grupo de Tratamento.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Replicar tabela: indivíduos do grupo Experimental que ingeriram / não ingeriram suco por mês</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Saída: objeto 'tabela_experimental_summary' e impressão formatada (kable HTML quando possível)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Copie/cole e execute no R/RStudio.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pacotes</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"knitr"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"kableExtra"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"kableExtra não encontrado: a impressão usará knitr::kable simples."</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"kableExtra"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())) <span class="fu">library</span>(kableExtra)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tinytex)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Dados (valores extraídos da imagem) ---</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>tabela_experimental_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">Mes =</span> <span class="fu">c</span>(<span class="st">"Abril"</span>,<span class="st">"Maio"</span>,<span class="st">"Junho"</span>,<span class="st">"Julho"</span>,<span class="st">"Agosto"</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Setembro"</span>,<span class="st">"Outubro"</span>,<span class="st">"Novembro"</span>,<span class="st">"Dezembro"</span>),</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">ing_n  =</span> <span class="fu">c</span>(<span class="dv">47</span>, <span class="dv">43</span>, <span class="dv">16</span>, <span class="dv">35</span>, <span class="dv">29</span>, <span class="dv">38</span>, <span class="dv">13</span>, <span class="dv">55</span>, <span class="dv">12</span>),  <span class="co"># ingeriram suco</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">not_n  =</span> <span class="fu">c</span>(<span class="dv">27</span>,  <span class="dv">2</span>, <span class="dv">20</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">5</span>,  <span class="dv">1</span>,  <span class="dv">4</span>,  <span class="dv">2</span>),  <span class="co"># não ingeriram suco</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Cálculos: total e percentuais (vetorizado) ---</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>tabela_experimental_summary <span class="ot">&lt;-</span> tabela_experimental_summary <span class="sc">%&gt;%</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> ing_n <span class="sc">+</span> not_n,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_ing =</span> <span class="fu">ifelse</span>(total <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> ing_n <span class="sc">/</span> total, <span class="cn">NA_real_</span>),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_not =</span> <span class="fu">ifelse</span>(total <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">100</span> <span class="sc">*</span> not_n <span class="sc">/</span> total, <span class="cn">NA_real_</span>),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># colunas formatadas com quebra de linha (HTML &lt;br/&gt;) para visual tipo tabela da imagem</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ingere     =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(total),</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste0</span>(ing_n, <span class="st">"&lt;br/&gt;("</span>, <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, pct_ing), <span class="st">")"</span>), <span class="cn">NA_character_</span>),</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">Nao_ingere =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(total),</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste0</span>(not_n, <span class="st">"&lt;br/&gt;("</span>, <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, pct_not), <span class="st">")"</span>), <span class="cn">NA_character_</span>),</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_fmt  =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(total),</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste0</span>(total, <span class="st">"&lt;br/&gt;(100%)"</span>), <span class="cn">NA_character_</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Mês <span class="ot">=</span> Mes, Ingere, Nao_ingere, <span class="at">Total =</span> Total_fmt)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Imprimir: tentar kable HTML com kableExtra; fallback para kable texto ---</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># if ("kableExtra" %in% rownames(installed.packages())) {</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   kable(tabela_experimental_summary, format = "html", escape = FALSE, align = c("l","c","c","c")) %&gt;%</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="co">#     kable_styling(full_width = FALSE, bootstrap_options = c("striped", "condensed")) %&gt;%</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_header_above(c(" " = 1, "Indivíduos do grupo experimental que ingeriram suco" = 1,</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co">#                        "Indivíduos do grupo experimental que não ingeriram suco" = 1,</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="co">#                        "Total" = 1))</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co"># } else {</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   # versão texto: usar \n nas células para console</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="co">#   tabela_texto &lt;- tabela_experimental_summary %&gt;%</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="co">#     mutate(</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="co">#       Ingere = gsub("&lt;br/&gt;", "\n", Ingere),</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="co">#       Nao_ingere = gsub("&lt;br/&gt;", "\n", Nao_ingere),</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="co">#       Total = gsub("&lt;br/&gt;", "\n", Total)</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("\nTabela Experimental — ingestão de suco por mês\n")</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="co">#   print(tabela_texto, right = FALSE, row.names = FALSE)</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="co"># # objeto disponível para uso posterior</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"tabela_experimental_summary"</span>, tabela_experimental_summary, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">kable</span>(tabela_experimental_summary,</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>            <span class="at">align =</span><span class="fu">c</span>(<span class="st">"l"</span>,<span class="st">"c"</span>,<span class="st">"c"</span>,<span class="st">"c"</span>)))</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Fim do script</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>

|Mês      |     Ingere      |   Nao_ingere    |     Total     |
|:--------|:---------------:|:---------------:|:-------------:|
|Abril    | 47&lt;br/&gt;(63.51%) | 27&lt;br/&gt;(36.49%) | 74&lt;br/&gt;(100%) |
|Maio     | 43&lt;br/&gt;(95.56%) |  2&lt;br/&gt;(4.44%)  | 45&lt;br/&gt;(100%) |
|Junho    | 16&lt;br/&gt;(44.44%) | 20&lt;br/&gt;(55.56%) | 36&lt;br/&gt;(100%) |
|Julho    | 35&lt;br/&gt;(94.59%) |  2&lt;br/&gt;(5.41%)  | 37&lt;br/&gt;(100%) |
|Agosto   | 29&lt;br/&gt;(90.62%) |  3&lt;br/&gt;(9.38%)  | 32&lt;br/&gt;(100%) |
|Setembro | 38&lt;br/&gt;(88.37%) | 5&lt;br/&gt;(11.63%)  | 43&lt;br/&gt;(100%) |
|Outubro  | 13&lt;br/&gt;(92.86%) |  1&lt;br/&gt;(7.14%)  | 14&lt;br/&gt;(100%) |
|Novembro | 55&lt;br/&gt;(93.22%) |  4&lt;br/&gt;(6.78%)  | 59&lt;br/&gt;(100%) |
|Dezembro | 12&lt;br/&gt;(85.71%) | 2&lt;br/&gt;(14.29%)  | 14&lt;br/&gt;(100%) |</code></pre>
</div>
</div>
<p>Tabela como impressa no artigo <span class="citation" data-cites="Aline-2020-sucouva">(<a href="referencias.html#ref-Aline-2020-sucouva" role="doc-biblioref">TOMÁS, 2020</a> , p.&nbsp;223)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="fig/dados-ingestao-suco-uva-GT.png" class="img-fluid figure-img"></p>
<figcaption>Quantidade e proporção de indivíduos que ingeriram e não ingeriram suco no grupo experimental</figcaption></figure>
</div>
<p>Gráfico da série temporal da ingestão de suco (sim/não) apenas no Grupo de Tratamento.</p>
<p>Com intervalo de confiança 95% para ponto da série.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Entrada: tabela_experimental_summary (criada anteriormente)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Saída: ts_suco_tratamento_table (tibble) e ts_suco_tratamento_plot (ggplot) no GlobalEnv</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># O script:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - detecta/obtém colunas numéricas (ing_n / not_n) ou extrai números de strings formatadas</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - normaliza meses na ordem Abril..Dezembro</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - calcula proporção de "Sim" e IC95% (prop.test) por mês</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># - plota linha com pontos e barras de erro (IC95%)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"tidyr"</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"scales"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"scales"</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(ggplot2); <span class="fu">library</span>(scales)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Verificar existência do objeto ---</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"tabela_experimental_summary"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Objeto 'tabela_experimental_summary' não encontrado no Global Environment."</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>tab_in <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"tabela_experimental_summary"</span>, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># normalizar nomes</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tab_in) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(tab_in))</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tab_in) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-z0-9_áéíóúâêôãõç]"</span>, <span class="st">"_"</span>, <span class="fu">names</span>(tab_in), <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># candidates for month and count columns</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>month_candidates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mes"</span>,<span class="st">"mês"</span>,<span class="st">"m"</span>,<span class="st">"month"</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>ing_candidates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ing_n"</span>,<span class="st">"ingere"</span>,<span class="st">"ingeriram"</span>,<span class="st">"ingeriram_suco"</span>,<span class="st">"ingested"</span>,<span class="st">"ing"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>not_candidates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"not_n"</span>,<span class="st">"nao_n"</span>,<span class="st">"nao"</span>,<span class="st">"nao_ingere"</span>,<span class="st">"nao_ingere"</span>,<span class="st">"not"</span>,<span class="st">"not_ing"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co"># localizar coluna de mês</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>find_col <span class="ot">&lt;-</span> <span class="cf">function</span>(nms, candidates) {</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  nms_l <span class="ot">&lt;-</span> <span class="fu">tolower</span>(nms)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  cand <span class="ot">&lt;-</span> <span class="fu">tolower</span>(candidates)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> nms[nms_l <span class="sc">%in%</span> cand]</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(m)) <span class="fu">return</span>(m[<span class="dv">1</span>])</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pat <span class="cf">in</span> cand) {</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    mm <span class="ot">&lt;-</span> nms[<span class="fu">grepl</span>(pat, nms_l, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(mm)) <span class="fu">return</span>(mm[<span class="dv">1</span>])</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>col_mes <span class="ot">&lt;-</span> <span class="fu">find_col</span>(<span class="fu">names</span>(tab_in), month_candidates)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>col_ing <span class="ot">&lt;-</span> <span class="fu">find_col</span>(<span class="fu">names</span>(tab_in), ing_candidates)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>col_not <span class="ot">&lt;-</span> <span class="fu">find_col</span>(<span class="fu">names</span>(tab_in), not_candidates)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(col_mes)) <span class="fu">stop</span>(<span class="st">"Não foi possível localizar a coluna de mês em 'tabela_experimental_summary'."</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="co"># --- função para extrair inteiro do início de uma string (tratamento de células formatadas) ---</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>extract_leading_int <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  xch <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove tags HTML e quebras, guarda primeiro inteiro encontrado</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>  xch <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]+&gt;"</span>, <span class="st">""</span>, xch)        <span class="co"># remover HTML tags</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  xch <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\\\</span><span class="st">n"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, xch)        <span class="co"># unescape se necessário</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(xch, <span class="cf">function</span>(s) {</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(s, <span class="fu">regexpr</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>, s))</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(m) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> m <span class="sc">==</span> <span class="st">""</span>) <span class="cn">NA_integer_</span> <span class="cf">else</span> <span class="fu">as.integer</span>(m)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="co"># tentar obter contagens numéricas diretamente</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>ing_vec <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_ing) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(tab_in[[col_ing]])) <span class="fu">as.integer</span>(tab_in[[col_ing]]) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>not_vec <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_not) <span class="sc">&amp;&amp;</span> <span class="fu">is.numeric</span>(tab_in[[col_not]])) <span class="fu">as.integer</span>(tab_in[[col_not]]) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="co"># se não numéricas, tentar extrair de strings formatadas (ex.: "47&lt;br/&gt;(63.51%)" ou "47\n(63.51%)")</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ing_vec) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(col_ing)) ing_vec <span class="ot">&lt;-</span> <span class="fu">extract_leading_int</span>(tab_in[[col_ing]])</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(not_vec) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(col_not)) not_vec <span class="ot">&lt;-</span> <span class="fu">extract_leading_int</span>(tab_in[[col_not]])</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="co"># se ainda NULL, tentar detectar colunas originais ing_n / not_n antes de formatação</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ing_vec)) {</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># talvez o objeto contenha colunas ing_n / not_n sem formatação</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>  alt_ing <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(tab_in), <span class="fu">c</span>(<span class="st">"ing_n"</span>,<span class="st">"ingeriram"</span>,<span class="st">"ingeriram_suco"</span>))</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(alt_ing)) ing_vec <span class="ot">&lt;-</span> <span class="fu">extract_leading_int</span>(tab_in[[alt_ing[<span class="dv">1</span>]]])</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(not_vec)) {</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  alt_not <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(tab_in), <span class="fu">c</span>(<span class="st">"not_n"</span>,<span class="st">"nao_n"</span>,<span class="st">"nao_ingere"</span>))</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(alt_not)) not_vec <span class="ot">&lt;-</span> <span class="fu">extract_leading_int</span>(tab_in[[alt_not[<span class="dv">1</span>]]])</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="co"># se não conseguimos obter contagens, aborta com mensagem informativa</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ing_vec) <span class="sc">||</span> <span class="fu">is.null</span>(not_vec)) {</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Não foi possível extrair contagens 'ingeriram' e 'não ingeriram' a partir de 'tabela_experimental_summary'. Verifique nomes/formatos das colunas."</span>)</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a><span class="co"># montar data.frame padronizado</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">mes_raw =</span> tab_in[[col_mes]],</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">ing_n =</span> ing_vec,</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">not_n =</span> not_vec,</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="co"># mapear meses e ordenar cronologicamente</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>month_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Abril"</span>,<span class="st">"Maio"</span>,<span class="st">"Junho"</span>,<span class="st">"Julho"</span>,<span class="st">"Agosto"</span>,<span class="st">"Setembro"</span>,<span class="st">"Outubro"</span>,<span class="st">"Novembro"</span>,<span class="st">"Dezembro"</span>)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>map_month <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(s), <span class="fu">tolower</span>(month_levels))</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(idx)) <span class="fu">return</span>(month_levels[idx])</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>  s_clean <span class="ot">&lt;-</span> <span class="fu">iconv</span>(s, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>  idx2 <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">tolower</span>(s_clean), <span class="fu">tolower</span>(<span class="fu">iconv</span>(month_levels, <span class="at">to =</span> <span class="st">"ASCII//TRANSLIT"</span>)))</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(idx2)) <span class="fu">return</span>(month_levels[idx2])</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>mes <span class="ot">&lt;-</span> <span class="fu">vapply</span>(df<span class="sc">$</span>mes_raw, map_month, <span class="fu">character</span>(<span class="dv">1</span>))</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mes))</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>mes <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>mes, <span class="at">levels =</span> month_levels)</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="co"># agregar por mês (caso haja múltiplas linhas)</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>per_month <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mes) <span class="sc">%&gt;%</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">successes =</span> <span class="fu">sum</span>(<span class="fu">as.integer</span>(ing_n), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> <span class="fu">sum</span>(<span class="fu">as.integer</span>(ing_n) <span class="sc">+</span> <span class="fu">as.integer</span>(not_n), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># garantir todos os meses na sequência</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">mes =</span> <span class="fu">factor</span>(month_levels, <span class="at">levels =</span> month_levels), <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">successes =</span> <span class="dv">0</span>, <span class="at">total =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mes)</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a><span class="co"># calcular proporção e IC95% (prop.test) por mês</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>per_month <span class="ot">&lt;-</span> per_month <span class="sc">%&gt;%</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop =</span> <span class="cf">if</span> (total <span class="sc">&gt;</span> <span class="dv">0</span>) successes <span class="sc">/</span> total <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci =</span> <span class="fu">list</span>(<span class="cf">if</span> (total <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">prop.test</span>(successes, total, <span class="at">correct =</span> <span class="cn">FALSE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(res)) <span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>) <span class="cf">else</span> <span class="fu">as.numeric</span>(res<span class="sc">$</span>conf.int)</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>)),</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_low =</span> ci[[<span class="dv">1</span>]],</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci_up  =</span> ci[[<span class="dv">2</span>]]</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a><span class="co"># salvar tabela de estatísticas</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"ts_suco_tratamento_table"</span>, per_month, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plot: linha com pontos e IC95% ---</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(per_month, <span class="fu">aes</span>(<span class="at">x =</span> mes, <span class="at">y =</span> prop, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#E31A1C"</span>, <span class="at">size =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"#E31A1C"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_up), <span class="at">width =</span> <span class="fl">0.12</span>, <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(prop), <span class="fu">paste0</span>(<span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, <span class="dv">100</span><span class="sc">*</span>prop), <span class="st">" (n="</span>, total, <span class="st">")"</span>), <span class="st">""</span>)),</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.1</span>),</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.1</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Série temporal — Proporção de ingestão de suco (Grupo Experimental)"</span>,</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Pontos: proporção mensal de 'Sim'; barras: IC95%-prop.test (n=288/354)"</span>,</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mês"</span>,</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Proporção de ingestão de suco"</span>,</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Fonte: tabela_experimental_summary"</span></span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a><span class="co"># salvar objeto de plot</span></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"ts_suco_tratamento_plot"</span>, p, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a><span class="co"># exibir</span></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="replicar-suco-uva-tab-graf_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>O gráfico acima evidencia a falha na troca do <em>nudge</em> utilizado apenas no mês de junho/2018.</p>
<p>Ele também evidencia a falta de explicação para a <u><strong>ausência de significância estatística</strong></u> verificada no <u><strong>teste qui-quadrado</strong></u> para os <strong>meses</strong> de <u><strong>setembro e outubro/2018</strong></u>. O que reforça ainda mais a <strong><em>necessidade de replicar o quasi-experimento</em></strong> a fim de testar se isso poderia ter sido provocado pela simples alea presente na variabilidade amostral, que acentua-se no caso de amostras pequenas, como ocorreu em outubro e dezembro (n = 14); mas não ocorreu em setembro/2018 (n = 43).</p>
</section><section id="gráfico-do-efeito-dos-conciliadores-no-gt" class="level3" data-number="8.2.7"><h3 data-number="8.2.7" class="anchored" data-anchor-id="gráfico-do-efeito-dos-conciliadores-no-gt">
<span class="header-section-number">8.2.7</span> Gráfico do efeito dos conciliadores no GT</h3>
<p>Replicar tabela 5 - Desempenho dos conciliadores – Tabelas com qui-quadrado, do artigo <span class="citation" data-cites="Aline-2020-sucouva">(<a href="referencias.html#ref-Aline-2020-sucouva" role="doc-biblioref">TOMÁS, 2020</a> , p.&nbsp;222)</span>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Recria tabela Observado + Esperado por conciliador (A, B, C, D)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># e formata expected com 1 casa decimal</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Saída: tabela_conciliadores_display, obs_mat_conciliadores, expected_mat_conciliadores, chisq_res_conciliadores</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"knitr"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Dados observados (copiados da imagem) ---</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>obs_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">35</span>, <span class="dv">28</span>, <span class="dv">21</span>, <span class="dv">21</span>,   <span class="co"># Controle</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">25</span>, <span class="dv">37</span>, <span class="dv">65</span>, <span class="dv">89</span>    <span class="co"># Experimental</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(obs_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Controle"</span>, <span class="st">"Experimental"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(obs_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Conciliador A"</span>, <span class="st">"Conciliador B"</span>, <span class="st">"Conciliador C"</span>, <span class="st">"Conciliador D"</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Totais e expected (numéricos para cálculo) ---</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>tot_col <span class="ot">&lt;-</span> <span class="fu">colSums</span>(obs_mat)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>tot_row <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(obs_mat)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>grand_total <span class="ot">&lt;-</span> <span class="fu">sum</span>(obs_mat)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>expected_mat <span class="ot">&lt;-</span> <span class="fu">outer</span>(tot_row, tot_col) <span class="sc">/</span> grand_total</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(expected_mat) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(obs_mat)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(expected_mat) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(obs_mat)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co"># chi-squared test (Pearson)</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>chisq_res <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">chisq.test</span>(obs_mat, <span class="at">correct =</span> <span class="cn">FALSE</span>))</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Preparar linhas para exibição ---</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Observados (inteiros)</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>obs_row1 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(obs_mat[<span class="dv">1</span>, ])</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>obs_row2 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(obs_mat[<span class="dv">2</span>, ])</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Esperados formatados com 1 casa decimal PARA EXIBIÇÃO</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>exp_row1_fmt <span class="ot">&lt;-</span> <span class="fu">formatC</span>(expected_mat[<span class="dv">1</span>, ], <span class="at">format =</span> <span class="st">"f"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>exp_row2_fmt <span class="ot">&lt;-</span> <span class="fu">formatC</span>(expected_mat[<span class="dv">2</span>, ], <span class="at">format =</span> <span class="st">"f"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Totais</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>tot_col_fmt <span class="ot">&lt;-</span> <span class="fu">as.character</span>(tot_col)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>total_obs_row1 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(tot_row[<span class="dv">1</span>])</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>total_obs_row2 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(tot_row[<span class="dv">2</span>])</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>total_expected_row1 <span class="ot">&lt;-</span> <span class="fu">formatC</span>(<span class="fu">sum</span>(expected_mat[<span class="dv">1</span>, ]), <span class="at">format =</span> <span class="st">"f"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>total_expected_row2 <span class="ot">&lt;-</span> <span class="fu">formatC</span>(<span class="fu">sum</span>(expected_mat[<span class="dv">2</span>, ]), <span class="at">format =</span> <span class="st">"f"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>grand_total_fmt <span class="ot">&lt;-</span> <span class="fu">as.character</span>(grand_total)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="co"># montar data.frame em ordem desejada (Controle, Esperado, Experimental, Esperado, Total)</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>df_display <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">Grupo =</span> <span class="fu">c</span>(<span class="st">"Controle"</span>, <span class="st">"Esperado"</span>, <span class="st">"Experimental"</span>, <span class="st">"Esperado"</span>, <span class="st">"Total"</span>),</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Conciliador A</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(obs_row1[<span class="dv">1</span>], exp_row1_fmt[<span class="dv">1</span>], obs_row2[<span class="dv">1</span>], exp_row2_fmt[<span class="dv">1</span>], tot_col_fmt[<span class="dv">1</span>]),</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Conciliador B</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(obs_row1[<span class="dv">2</span>], exp_row1_fmt[<span class="dv">2</span>], obs_row2[<span class="dv">2</span>], exp_row2_fmt[<span class="dv">2</span>], tot_col_fmt[<span class="dv">2</span>]),</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Conciliador C</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(obs_row1[<span class="dv">3</span>], exp_row1_fmt[<span class="dv">3</span>], obs_row2[<span class="dv">3</span>], exp_row2_fmt[<span class="dv">3</span>], tot_col_fmt[<span class="dv">3</span>]),</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Conciliador D</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(obs_row1[<span class="dv">4</span>], exp_row1_fmt[<span class="dv">4</span>], obs_row2[<span class="dv">4</span>], exp_row2_fmt[<span class="dv">4</span>], tot_col_fmt[<span class="dv">4</span>]),</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">Total =</span> <span class="fu">c</span>(total_obs_row1, total_expected_row1, total_obs_row2, total_expected_row2, grand_total_fmt),</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Imprimir tabela com formato simples ---</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tabela: Desempenho dos conciliadores — Observado / Esperado</span><span class="sc">\n</span><span class="st">(ambos com 1 casa decimal) apenas quando houve acordo</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_display)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="co"># print(knitr::kable(df_display, format = kable_format, escape = FALSE, align = align_vec, booktabs = TRUE))</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Imprimir resultado do qui-quadrado ---</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Resultado do teste qui-quadrado (Pearson):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"X-squared = %.2f, df = %d, p-value = %g</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.numeric</span>(chisq_res<span class="sc">$</span>statistic), chisq_res<span class="sc">$</span>parameter, chisq_res<span class="sc">$</span>p.value))</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="co"># salvar objetos no Global Environment</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"obs_mat_conciliadores"</span>, obs_mat, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"expected_mat_conciliadores"</span>, expected_mat, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"chisq_res_conciliadores"</span>, chisq_res, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"tabela_conciliadores_display"</span>, df_display, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Tabela: Desempenho dos conciliadores — Observado / Esperado
(ambos com 1 casa decimal) apenas quando houve acordo

         Grupo Conciliador.A Conciliador.B Conciliador.C Conciliador.D Total
1     Controle            35            28            21            21   105
2     Esperado          19.6          21.3          28.1          36.0 105.0
3 Experimental            25            37            65            89   216
4     Esperado          40.4          43.7          57.9          74.0 216.0
5        Total            60            65            86           110   321

Resultado do teste qui-quadrado (Pearson):
X-squared = 33.03, df = 3, p-value = 3.17907e-07</code></pre>
</div>
</div>
<p>Observar que o total de audiências presidida pelos quatro conciliadores foi <strong>321</strong>.</p>
<p>O que é bem menor que o total geral de audiências do esperimento: <strong>659</strong>.</p>
<p>Uma diferença de <strong>-321</strong> audiências, que foi parcialmente exlicada no artigo.</p>
<blockquote class="blockquote">
<p>“Durante o primeiro mês da pesquisa (abril de 2018), nenhum registro foi feito em relação aos conciliadores. Apenas a partir de maio de 2018 a variável ‘conciliador’ começou a ser mensurada, não havendo informação sobre a atuação de conciliadores em <em><strong>140</strong> audiências realizadas em abril</em>.” <span class="citation" data-cites="Aline-2020-sucouva">(<a href="referencias.html#ref-Aline-2020-sucouva" role="doc-biblioref">TOMÁS, 2020</a> , p.&nbsp;222)</span></p>
</blockquote>
<p>Gerar gráfico de barras lado a lado para exibir o desempnho dos conciliadores em audiências com acordo no Grupo de Controle e Experimental.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Script corrigido: proporções de acordos por conciliador (A,B,C,D)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Corrige bug que mapeava erroneamente vários rótulos para "C" (ex.: detectava 'C' em "Controle")</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Saída: df_counts_conciliadores, plot_long_conciliadores, p_conciliadores_proporcao</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"tidyr"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"scales"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"scales"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2); <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(scales)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># conciliadores esperados (ordem fixa)</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>desired <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>,<span class="st">"D"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># helper: extrai inteiro inicial de string (ex: "47&lt;br/&gt;(63.51%)" -&gt; 47)</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>extract_leading_int <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  xch <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(xch, <span class="cf">function</span>(s) {</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(s, <span class="fu">regexpr</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>, s))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(m) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> m <span class="sc">==</span> <span class="st">""</span>) <span class="cn">NA_integer_</span> <span class="cf">else</span> <span class="fu">as.integer</span>(m)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># CORREÇÃO: função robusta para extrair letra conciliador (A-D)</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>extract_letter <span class="ot">&lt;-</span> <span class="cf">function</span>(name) {</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(name)) <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">as.character</span>(name)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  s_trim <span class="ot">&lt;-</span> <span class="fu">trimws</span>(s)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) procurar letra A-D como token isolado (word boundary) - evita "Controle"</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(s_trim, <span class="fu">regexpr</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">b([A-Da-d])</span><span class="sc">\\</span><span class="st">b"</span>, s_trim, <span class="at">perl =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(m1) <span class="sc">&amp;&amp;</span> <span class="fu">nzchar</span>(m1)) <span class="fu">return</span>(<span class="fu">toupper</span>(m1))</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2) procurar letra A-D no final do rótulo (ex.: "Conciliador A", "A")</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  m2 <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(s_trim, <span class="fu">regexpr</span>(<span class="st">"([A-Da-d])</span><span class="sc">\\</span><span class="st">s*$"</span>, s_trim, <span class="at">perl =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(m2) <span class="sc">&amp;&amp;</span> <span class="fu">nzchar</span>(m2)) <span class="fu">return</span>(<span class="fu">toupper</span>(m2))</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3) procurar padrão "conciliador ... A" ou "conciliador_a"</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  m3 <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(s_trim, <span class="fu">regexpr</span>(<span class="st">"conciliador[^A-Za-z0-9]*([A-Da-d])"</span>, s_trim, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">perl =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(m3) <span class="sc">&amp;&amp;</span> <span class="fu">nzchar</span>(m3)) {</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract captured group</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    cap <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*([A-Da-d]).*$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, m3)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">toupper</span>(cap))</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4) fallback: primeira letter of last token if it matches A-D</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  toks <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">gsub</span>(<span class="st">"[^A-Za-z0-9 ]"</span>, <span class="st">" "</span>, s_trim), <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>))</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(toks) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    last <span class="ot">&lt;-</span> toks[<span class="fu">length</span>(toks)]</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    fl <span class="ot">&lt;-</span> <span class="fu">toupper</span>(<span class="fu">substr</span>(last, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fl <span class="sc">%in%</span> desired) <span class="fu">return</span>(fl)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nothing found</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>df_counts <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) usar obs_mat_conciliadores (matrix) se existir</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"obs_mat_conciliadores"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  obs_mat <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"obs_mat_conciliadores"</span>, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  cn <span class="ot">&lt;-</span> <span class="fu">colnames</span>(obs_mat)</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cn)) cn <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Col"</span>, <span class="fu">seq_len</span>(<span class="fu">ncol</span>(obs_mat)))</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  letters <span class="ot">&lt;-</span> <span class="fu">sapply</span>(cn, extract_letter, <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># se não extraiu corretamente para alguma coluna, tentar pegar último caractere</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  letters[<span class="fu">is.na</span>(letters)] <span class="ot">&lt;-</span> <span class="fu">toupper</span>(<span class="fu">substr</span>(<span class="fu">gsub</span>(<span class="st">"[^A-Za-z0-9]"</span>, <span class="st">""</span>, cn[<span class="fu">is.na</span>(letters)]), <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  df_counts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">conciliador =</span> letters,</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">Controle =</span> <span class="fu">as.integer</span>(<span class="cf">if</span> (<span class="st">"Controle"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(obs_mat)) obs_mat[<span class="st">"Controle"</span>, , <span class="at">drop =</span> <span class="cn">TRUE</span>]</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">else</span> <span class="cf">if</span> (<span class="st">"Control"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(obs_mat)) obs_mat[<span class="st">"Control"</span>, , <span class="at">drop =</span> <span class="cn">TRUE</span>]</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">else</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(obs_mat))),</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">Experimental =</span> <span class="fu">as.integer</span>(<span class="cf">if</span> (<span class="st">"Experimental"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(obs_mat)) obs_mat[<span class="st">"Experimental"</span>, , <span class="at">drop =</span> <span class="cn">TRUE</span>]</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>                              <span class="cf">else</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(obs_mat))),</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) tentar tabela_conciliadores_summary se existir</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(df_counts) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"tabela_conciliadores_summary"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  tab <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"tabela_conciliadores_summary"</span>, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  conciliador_col <span class="ot">&lt;-</span> <span class="fu">names</span>(tab)[<span class="dv">1</span>]</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tentar localizar colunas numéricas de ingere/not</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>  num_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(tab)[<span class="fu">sapply</span>(tab, is.numeric)]</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(num_cols) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># presumir que uma coluna é Experimental e outra Controle (usuário deve verificar)</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    df_counts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">conciliador =</span> <span class="fu">sapply</span>(tab[[conciliador_col]], extract_letter),</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">Experimental =</span> <span class="fu">as.integer</span>(tab[[num_cols[<span class="dv">1</span>]]]),</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">Controle =</span> <span class="fu">as.integer</span>(tab[[num_cols[<span class="dv">2</span>]]]),</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extrair de strings formatadas</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    col_ing <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"ing|ingere|ingeram|sim"</span>, <span class="fu">names</span>(tab), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    col_not <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"nao|not|controle"</span>, <span class="fu">names</span>(tab), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(col_ing) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(col_not)) {</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>      df_counts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">conciliador =</span> <span class="fu">sapply</span>(tab[[conciliador_col]], extract_letter),</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">Experimental =</span> <span class="fu">extract_leading_int</span>(tab[[col_ing]]),</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">Controle =</span> <span class="fu">extract_leading_int</span>(tab[[col_not]]),</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) fallback: usar tabela_final nível individual</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(df_counts) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"tabela_final"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>  tf <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"tabela_final"</span>, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(tf) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(tf))</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>  col_conc <span class="ot">&lt;-</span> <span class="fu">names</span>(tf)[<span class="fu">grepl</span>(<span class="st">"conciliador|conc|mediador|operador"</span>, <span class="fu">names</span>(tf), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)][<span class="dv">1</span>]</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>  col_grp  <span class="ot">&lt;-</span> <span class="fu">names</span>(tf)[<span class="fu">grepl</span>(<span class="st">"grupo|group|tratamento|condition"</span>, <span class="fu">names</span>(tf), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)][<span class="dv">1</span>]</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>  col_acr  <span class="ot">&lt;-</span> <span class="fu">names</span>(tf)[<span class="fu">grepl</span>(<span class="st">"acordo|agreement|resposta|sim|yes"</span>, <span class="fu">names</span>(tf), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)][<span class="dv">1</span>]</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(col_conc) <span class="sc">||</span> <span class="fu">is.na</span>(col_grp) <span class="sc">||</span> <span class="fu">is.na</span>(col_acr)) {</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Não identifiquei colunas conciliador/grupo/acordo em tabela_final; forneça obs_mat_conciliadores ou tabela_conciliadores_summary."</span>)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>  tf2 <span class="ot">&lt;-</span> tf <span class="sc">%&gt;%</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">conciliador =</span> <span class="fu">toupper</span>(<span class="fu">substr</span>(<span class="fu">trimws</span>(<span class="fu">as.character</span>(.data[[col_conc]])), <span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">grupo =</span> <span class="fu">ifelse</span>(<span class="fu">tolower</span>(<span class="fu">trimws</span>(<span class="fu">as.character</span>(.data[[col_grp]]))) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"controle"</span>,<span class="st">"control"</span>), <span class="st">"Controle"</span>, <span class="st">"Experimental"</span>),</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">acordo =</span> <span class="fu">tolower</span>(<span class="fu">trimws</span>(<span class="fu">as.character</span>(.data[[col_acr]]))),</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">agree =</span> <span class="fu">ifelse</span>(acordo <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"s"</span>,<span class="st">"sim"</span>,<span class="st">"yes"</span>,<span class="st">"y"</span>,<span class="st">"1"</span>,<span class="st">"true"</span>), <span class="dv">1</span>,</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">ifelse</span>(acordo <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"n"</span>,<span class="st">"nao"</span>,<span class="st">"não"</span>,<span class="st">"no"</span>,<span class="st">"0"</span>,<span class="st">"false"</span>), <span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(conciliador <span class="sc">%in%</span> desired)</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>  tab_counts <span class="ot">&lt;-</span> tf2 <span class="sc">%&gt;%</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(conciliador, grupo) <span class="sc">%&gt;%</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">agreements =</span> <span class="fu">sum</span>(agree <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>  df_counts <span class="ot">&lt;-</span> tab_counts <span class="sc">%&gt;%</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> grupo, <span class="at">values_from =</span> agreements, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Controle =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Controle), <span class="dv">0</span>, Controle),</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>           <span class="at">Experimental =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Experimental), <span class="dv">0</span>, Experimental),</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>           <span class="at">conciliador =</span> <span class="fu">as.character</span>(conciliador))</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(df_counts)) <span class="fu">stop</span>(<span class="st">"Falha ao construir df_counts. Forneça dados em formato esperado."</span>)</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a><span class="co"># normalizar conciliador e garantir A-D presentes</span></span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>df_counts <span class="ot">&lt;-</span> df_counts <span class="sc">%&gt;%</span></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conciliador =</span> <span class="fu">sapply</span>(conciliador, <span class="cf">function</span>(x) {</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(x)) <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_letter</span>(x)</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">%&gt;%</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(conciliador)) <span class="sc">%&gt;%</span></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(conciliador) <span class="sc">%&gt;%</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Controle =</span> <span class="fu">sum</span>(<span class="fu">as.integer</span>(Controle), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>            <span class="at">Experimental =</span> <span class="fu">sum</span>(<span class="fu">as.integer</span>(Experimental), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">conciliador =</span> desired, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">Controle =</span> <span class="dv">0</span>, <span class="at">Experimental =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">match</span>(conciliador, desired))</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Contagens por conciliador (Controle / Experimental):"</span>)</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_counts)</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a><span class="co"># preparar dados long e calcular proporção dentro de cada conciliador</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>plot_long <span class="ot">&lt;-</span> df_counts <span class="sc">%&gt;%</span></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"Controle"</span>,<span class="st">"Experimental"</span>), <span class="at">names_to =</span> <span class="st">"grupo"</span>, <span class="at">values_to =</span> <span class="st">"agreements"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(conciliador) <span class="sc">%&gt;%</span></span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_by_conc =</span> <span class="fu">sum</span>(agreements, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>         <span class="at">prop_within_conc =</span> <span class="fu">ifelse</span>(total_by_conc <span class="sc">&gt;</span> <span class="dv">0</span>, agreements <span class="sc">/</span> total_by_conc, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Dados long para plotagem (verifique se A-D aparecem):"</span>)</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(plot_long)</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>p_conciliadores_proporcao <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_long, <span class="fu">aes</span>(<span class="at">x =</span> conciliador, <span class="at">y =</span> prop_within_conc, <span class="at">fill =</span> grupo)) <span class="sc">+</span></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.8</span>), <span class="at">width =</span> <span class="fl">0.7</span>, <span class="at">colour =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(prop_within_conc), scales<span class="sc">::</span><span class="fu">percent</span>(prop_within_conc, <span class="at">accuracy =</span> <span class="fl">0.1</span>), <span class="st">"0.0%"</span>)),</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.8</span>), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Controle"</span> <span class="ot">=</span> <span class="st">"#4E79A7"</span>, <span class="st">"Experimental"</span> <span class="ot">=</span> <span class="st">"#F28E2B"</span>)) <span class="sc">+</span></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Proporção de acordos por conciliador (por Grupos)"</span>,</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Comparação: Controle vs Experimental apenas quando houve acordo"</span>,</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Conciliador"</span>, <span class="at">y =</span> <span class="st">"Proporção de acordos (por conciliador)"</span>,</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Grupo"</span>) <span class="sc">+</span></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"df_counts_conciliadores"</span>, df_counts, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"plot_long_conciliadores"</span>, plot_long, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"p_conciliadores_proporcao"</span>, p_conciliadores_proporcao, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_conciliadores_proporcao)</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  conciliador Controle Experimental
  &lt;chr&gt;          &lt;int&gt;        &lt;int&gt;
1 A                 35           25
2 B                 28           37
3 C                 21           65
4 D                 21           89
# A tibble: 8 × 5
  conciliador grupo        agreements total_by_conc prop_within_conc
  &lt;chr&gt;       &lt;chr&gt;             &lt;int&gt;         &lt;int&gt;            &lt;dbl&gt;
1 A           Controle             35            60            0.583
2 A           Experimental         25            60            0.417
3 B           Controle             28            65            0.431
4 B           Experimental         37            65            0.569
5 C           Controle             21            86            0.244
6 C           Experimental         65            86            0.756
7 D           Controle             21           110            0.191
8 D           Experimental         89           110            0.809</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="replicar-suco-uva-tab-graf_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Há um claro padrão discrepante no desempenho dos conciliadores C e D em relação aos conciliadores A e B.</p>
<p>Considerando que todos os conciliadores foram orientados para aplicarem sempre a mesma e única técnica de conciliação, essa discrepância acentuada é uma evidência de que C e D podem ter atuado com mais eficácia no Grupo Experimental que no Grupo de Controle.</p>
<p>mmm</p>


<div id="refs" class="references csl-bib-body" data-entry-spacing="1" role="list" style="display: none">
<div id="ref-Moore2023" class="csl-entry" role="listitem">
MOORE, David S.; NOTZ, William I.; FLIGNER, Michael A. <strong><a href="https://www.grupogen.com.br/livro-a-estatistica-basica-e-sua-pratica-david-s-moore-william-i-notz-e-michael-a-fligner-editora-ltc-9788521638605">Estatística básica e sua prática</a></strong>. 9. ed. Rio de Janeiro: LTC, 2023.
</div>
<div id="ref-Aline-2020-sucouva" class="csl-entry" role="listitem">
TOMÁS, Aline Vieira. <a href="https://www.cnj.jus.br/ojs/revista-cnj/article/view/170/67">Resultados alcançados pelo projeto adoce: Acordos após ingestão de glicose observados em conciliações judiciais (processuais) e extrajudiciais (pré-processuais)</a>. <strong>Revista Eletrônica CNJ</strong>, v. 4, n. 2, p. 212–232, 2020.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./cap6-moore-tab-dupla-entrada.html" class="pagination-link" aria-label="AED - cap 6 moore - Tabelas de Dupla Entrada">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">AED - cap 6 moore - Tabelas de Dupla Entrada</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cap16-moore-IC-o-basico.html" class="pagination-link" aria-label="AEI - cap 16 moore - IC: o Básico">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">AEI - cap 16 moore - IC: o Básico</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Relatório escrito em <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>